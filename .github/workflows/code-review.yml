name: Code Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  code-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout base repo (trusted)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies (from base repo)
        run: pnpm install --frozen-lockfile

      - name: Fetch PR head (as data only)
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          echo "PR_HEAD_SHA=$(git rev-parse pr)" >> $GITHUB_ENV
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV

      - name: Run Code Review
        id: review
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        run: |
          # ç›´æŽ¥è¿è¡Œ TypeScript æ–‡ä»¶
          OUTPUT=$(npx tsx scripts/code-review.ts ${{ github.event.pull_request.number }} $BASE_SHA $PR_HEAD_SHA)

          # æå–æŠ¥å‘Šå†…å®¹
          REPORT=$(echo "$OUTPUT" | sed -n '/---REPORT_START---/,/---REPORT_END---/p' | sed '1d;$d')

          # ä¿å­˜æŠ¥å‘Š
          echo "$REPORT" > review.md

          # è¾“å‡ºåˆ° GitHub Actions æ—¥å¿—
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review.md', 'utf8');

            // æŸ¥æ‰¾çŽ°æœ‰çš„å®¡æŸ¥è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š')
            );

            if (existingComment) {
              // æ›´æ–°çŽ°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: reviewContent
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reviewContent
              });
            }

      - name: Create Review Summary
        run: |
          echo "## ðŸ“‹ ä»£ç å®¡æŸ¥æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å·²ä½¿ç”¨ DeepSeek æ¨¡åž‹å®Œæˆä»£ç å®¡æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— æŸ¥çœ‹è¯¦ç»†å®¡æŸ¥ç»“æžœè¯·æŸ¥çœ‹ PR è¯„è®º" >> $GITHUB_STEP_SUMMARY
