name: Code Review

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  code-review:
    runs-on: ubuntu-latest
    # ä»…åœ¨ pull_request_targetï¼ˆå¯è®¿é—® secretsï¼‰ä¸”éè‰ç¨¿æ—¶è¿è¡Œ
    if: github.event_name == 'pull_request_target' && github.event.pull_request.draft == false

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout base repo (trusted)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies (from base repo)
        run: pnpm install --frozen-lockfile

      - name: Fetch PR head (as data only)
        run: |
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr
          echo "PR_HEAD_SHA=$(git rev-parse pr)" >> $GITHUB_ENV
          echo "BASE_SHA=${{ github.event.pull_request.base.sha }}" >> $GITHUB_ENV

      - name: Run Code Review
        id: review
        env:
          SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        run: |
          # ç›´æ¥è¿è¡Œ TypeScript æ–‡ä»¶
          OUTPUT=$(npx tsx scripts/code-review.ts ${{ github.event.pull_request.number }} $BASE_SHA $PR_HEAD_SHA)

          # æå–æŠ¥å‘Šå†…å®¹ï¼ˆç”±ä½ çš„è„šæœ¬ä»¥ --REPORT_START/END-- åŒ…å›´ï¼‰
          REPORT=$(echo "$OUTPUT" | sed -n '/---REPORT_START---/,/---REPORT_END---/p' | sed '1d;$d')

          # ä¿å­˜æŠ¥å‘Šä¾›ä¸‹ä¸€æ­¥è¯„è®ºä½¿ç”¨
          echo "$REPORT" > review.md

          # ä¹Ÿè¾“å‡ºåˆ° job è¾“å‡ºï¼ˆå¦‚éœ€å¤ç”¨ï¼‰
          {
            echo "review<<EOF"
            echo "$REPORT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– AI ä»£ç å®¡æŸ¥æŠ¥å‘Š')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: reviewContent
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: reviewContent
              });
            }