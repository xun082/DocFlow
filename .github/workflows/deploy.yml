name: Deploy to Server via Docker Hub

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.0

      - name: Extract version
        id: version
        run: |
          VERSION="$(echo ${{ github.sha }} | cut -c1-7)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/docflow:latest
            ${{ secrets.DOCKER_USERNAME }}/docflow:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.2.1
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          VERSION: ${{ needs.build-and-push.outputs.version }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          port: ${{ secrets.SERVER_PORT }}
          password: ${{ secrets.SERVER_PASSWORD }}
          command_timeout: 30m
          envs: DOCKER_USERNAME,DOCKER_PASSWORD,VERSION
          script: |
            IMAGE="${DOCKER_USERNAME}/docflow:latest"
            # ä½¿ç”¨ DaoCloud é•œåƒåŠ é€Ÿ
            MIRROR_IMAGE="m.daocloud.io/docker.io/${IMAGE}"

            echo "================================"
            echo "ðŸš€ Starting deployment"
            echo "ðŸ“¦ Version: $VERSION"
            echo "ðŸ³ Original: $IMAGE"
            echo "ðŸš„ Mirror: $MIRROR_IMAGE"
            echo "================================"

            # æµ‹è¯•ç½‘ç»œè¿žæŽ¥
            echo "ðŸ” Testing network connectivity..."
            if curl -sL -m 5 https://docker.m.daocloud.io > /dev/null; then
              echo "âœ… DaoCloud mirror accessible"
            else
              echo "âŒ DaoCloud mirror not accessible"
              exit 1
            fi

            # ä»Ž DaoCloud é•œåƒåŠ é€Ÿæ‹‰å–
            echo ""
            echo "ðŸ“¦ Pulling image via DaoCloud mirror..."
            PULL_SUCCESS=0
            for i in 1 2 3; do
              echo "ðŸ”„ Pull attempt $i/3..."
              if timeout 600 docker pull $MIRROR_IMAGE; then
                echo "âœ… Image pulled successfully from mirror"
                PULL_SUCCESS=1
                break
              fi
              echo "âš ï¸  Pull attempt $i failed, retrying..."
              sleep 10
            done

            if [ $PULL_SUCCESS -eq 0 ]; then
              echo "âŒ Failed to pull image after 3 attempts"
              echo "Please check: https://hub.docker.com/r/${DOCKER_USERNAME}/docflow"
              exit 1
            fi

            # é‡æ–°æ ‡è®°ä¸ºåŽŸå§‹é•œåƒåï¼ˆæ–¹ä¾¿åŽç»­ä½¿ç”¨ï¼‰
            echo ""
            echo "ðŸ·ï¸  Tagging image as: $IMAGE"
            docker tag $MIRROR_IMAGE $IMAGE

            echo "âœ… Image ready: $IMAGE"

            # åœæ­¢æ—§å®¹å™¨
            echo ""
            echo "ðŸ›‘ Stopping old container..."
            docker stop docflow 2>/dev/null || true
            docker rm docflow 2>/dev/null || true

            # å¯åŠ¨æ–°å®¹å™¨
            echo ""
            echo "ðŸš€ Starting new container..."
            CONTAINER_ID=$(docker run -d \
              --name docflow \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              $IMAGE)

            if [ -z "$CONTAINER_ID" ]; then
              echo "âŒ Failed to start container"
              docker logout 2>/dev/null
              exit 1
            fi

            echo "Container ID: $CONTAINER_ID"

            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "â³ Waiting for container to start..."
            sleep 5

            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo ""
            echo "================================"
            echo "ðŸ“Š Container Status Check"
            echo "================================"

            CONTAINER_STATUS=$(docker inspect -f '{{.State.Status}}' docflow 2>/dev/null)

            if [ "$CONTAINER_STATUS" = "running" ]; then
              echo "âœ… Container is running!"
              echo ""
              echo "ðŸ“‹ Container Info:"
              docker ps --filter "name=docflow" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              echo "ðŸ“‹ Recent Logs:"
              docker logs --tail 30 docflow
              echo ""
              echo "ðŸŽ‰ Deployment successful!"
            else
              echo "âŒ Container is not running (Status: $CONTAINER_STATUS)"
              echo ""
              echo "ðŸ“‹ Container Logs:"
              docker logs docflow 2>&1
              echo ""
              docker logout 2>/dev/null
              exit 1
            fi

            docker logout 2>/dev/null
            echo "Done!"

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Version: \`${{ needs.build-and-push.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Image: [Docker Hub](https://hub.docker.com/r/${{ secrets.DOCKER_USERNAME }}/docflow)" >> $GITHUB_STEP_SUMMARY
          echo "- â° Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
